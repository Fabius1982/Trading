<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Trading Crypto</title>
    
    <!-- Meta per l'aspetto su mobile -->
    <meta name="theme-color" content="#1a202c"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Crypto Trading">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=CT">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .profit { color: #10b981; font-weight: 600; }
        .loss { color: #ef4444; font-weight: 600; }
        .day-cell { min-height: 160px; border: 1px solid #333; border-radius: 0.5rem; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; }
        .trade-item { border: 1px solid #4a5568; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; line-height: 1.2; }
        .trade-actions { display: flex; gap: 0.25rem; margin-top: 0.5rem; }
        .action-btn { padding: 0.15rem 0.3rem; font-size: 0.65rem; border-radius: 0.2rem; color: white; cursor: pointer; }
        .day-action-btn { flex-grow: 1; color: white; font-semibold; padding: 0.25rem; border-radius: 0.375rem; font-size: 0.75rem; transition: background-color 0.2s; cursor: pointer; }
        .day-action-btn:disabled, .modal-btn:disabled { background-color: #4a5568; cursor: not-allowed; opacity: 0.6; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 600px;
            position: relative;
            color: #e2e8f0;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
             overflow-y: auto;
             padding-top: 1rem;
        }
        .modal-input { width: 100%; border: 1px solid #4a5568; border-radius: 0.375rem; padding: 0.5rem; background-color: #1a202c; color: #e2e8f0; }
        .modal-btn { font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem; shadow-md transition duration-300; cursor: pointer; }
        .font-minecraft { font-family: 'Press Start 2P', cursive; }
        .text-gold-gradient {
          background-image: linear-gradient(to top, #DAA520, #FFD700, #FFFACD);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
        }
        .ticker-wrap {
          width: 100%;
          overflow: hidden;
          background-color: #1a202c;
          padding: 0.5rem 0;
          white-space: nowrap;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .ticker-move {
          display: inline-block;
          animation: ticker 180s linear infinite;
        }
        .ticker-item {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0 1.5rem;
          color: #e2e8f0;
          font-size: 0.9rem;
        }
        .ticker-item img {
          width: 20px;
          height: 20px;
        }
        @keyframes ticker {
          0% { transform: translateX(0); }
          100% { transform: translateX(-100%); }
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="app-container" class="min-h-screen p-2 sm:p-4 flex flex-col items-center">
        <!-- Header Section -->
        <div class="w-full max-w-4xl mx-auto">
            <div class="w-full max-w-lg mx-auto my-4">
                <form id="search-form" class="relative flex items-center">
                    <input id="search-input" type="text" placeholder="Cerca su Google..." class="w-full pl-4 pr-10 py-2 text-gray-100 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="absolute inset-y-0 right-0 flex items-center pr-3" aria-label="Cerca">
                        <svg class="w-5 h-5 text-gray-400 hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </form>
            </div>
            
            <div id="ticker-container" class="ticker-wrap my-4 rounded-lg"></div>

            <h1 class="font-minecraft text-lg sm:text-2xl text-gray-50 mb-2 mt-4 text-center">
                <span class="text-gold-gradient">G</span>estore <span class="text-gold-gradient">T</span>rading <span class="text-gold-gradient">C</span>rypto
            </h1>
        </div>

        <!-- Main Content -->
        <div class="w-full max-w-4xl mx-auto mt-6">
            <div class="flex justify-center items-center gap-1 sm:gap-2 mb-4 w-full px-1">
                <button id="prev-year-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-2 sm:px-4 py-1 sm:py-2 rounded-lg text-xs sm:text-sm transition-colors">&lt;&lt; Anno</button>
                <button id="prev-month-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-2 sm:px-4 py-1 sm:py-2 rounded-lg text-xs sm:text-sm transition-colors">&lt; Mese</button>
                <span id="current-month-year" class="text-base sm:text-lg font-bold text-gray-50 min-w-[110px] sm:min-w-[120px] text-center"></span>
                <button id="next-month-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-2 sm:px-4 py-1 sm:py-2 rounded-lg text-xs sm:text-sm transition-colors">Mese &gt;</button>
                <button id="next-year-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold px-2 sm:px-4 py-1 sm:py-2 rounded-lg text-xs sm:text-sm transition-colors">Anno &gt;&gt;</button>
            </div>
            <div id="calendar-container"></div>
        </div>
        
        <!-- Footer Section -->
        <footer class="w-full max-w-4xl mx-auto text-center py-8 mt-auto">
            <p class="text-xs text-gray-500">
                &copy; <span id="copyright-year"></span> Fabio Amendola. Tutti i diritti riservati. | 
                <a href="mailto:fabius.amendola@gmail.com" class="hover:text-gray-300">fabius.amendola@gmail.com</a>
            </p>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let state = {
            trades: [],
            currentYear: new Date().getFullYear(),
            currentMonthIndex: new Date().getMonth(),
            tickerData: [],
            modal: { isOpen: false, mode: null, data: null },
            confirmationModal: { isOpen: false, message: '', onConfirm: null },
            infoModal: { isOpen: false, title: '', content: '', isLoading: false },
        };
        let profitChart = null;

        // --- LOCAL STORAGE FUNCTIONS ---
        function loadTrades() {
            const savedTrades = localStorage.getItem('cryptoTrades');
            if (savedTrades) {
                try {
                    const parsed = JSON.parse(savedTrades);
                    if (Array.isArray(parsed)) {
                        state.trades = parsed;
                    }
                } catch (e) {
                    console.error("Could not parse trades from localStorage", e);
                    state.trades = [];
                }
            }
        }
        function saveTrades() {
            localStorage.setItem('cryptoTrades', JSON.stringify(state.trades));
        }
        
        // --- UTILITY FUNCTIONS ---
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const formatDate = (dateStr) => { if (!dateStr) return ''; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; };
        const calculateTradeProfits = (trade) => {
            if (trade.status !== 'closed' || !trade.salePrice) return { ...trade, netProfit: 0, percentageProfit: 0 };
            const netProfit = (trade.salePrice - trade.purchasePrice) * trade.quantity;
            const costBasis = trade.purchasePrice * trade.quantity;
            const percentageProfit = costBasis !== 0 ? (netProfit / costBasis) * 100 : 0;
            return { ...trade, netProfit, percentageProfit };
        };
        const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }));

        // --- RENDER FUNCTIONS ---
        function render() {
            document.getElementById('ticker-container').innerHTML = renderTicker();
            document.getElementById('current-month-year').textContent = `${monthNames[state.currentMonthIndex]} ${state.currentYear}`;
            document.getElementById('calendar-container').innerHTML = renderCalendar();
            document.getElementById('modals-container').innerHTML = renderAllModals();
            renderChart();
        }

        function renderTicker() {
            if (!navigator.onLine && state.tickerData.length === 0) {
                 return `<div class="ticker-item">Ticker non disponibile in modalità offline.</div>`;
            }
            if (state.tickerData.length === 0) return `<div class="ticker-item">Caricamento prezzi...</div>`;
            const items = state.tickerData.map(coin => `
                <span class="ticker-item">
                    <img src="${coin.image}" alt="${coin.name}" class="w-5 h-5"/>
                    ${coin.name}: <span class="${coin.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">
                        $${coin.current_price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </span>
                </span>
            `).join('');
            return `<div class="ticker-move">${items}${items}</div>`;
        }

        function renderCalendar() {
            const { currentYear, currentMonthIndex, trades } = state;
            const daysInMonth = getDaysInMonth(currentYear, currentMonthIndex);
            
            const monthKey = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
            const tradesInMonth = trades.filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(monthKey));
            const monthNetProfit = tradesInMonth.reduce((acc, t) => acc + (calculateTradeProfits(t).netProfit || 0), 0);
            const monthCostBasis = tradesInMonth.reduce((acc, t) => acc + (t.purchasePrice * t.quantity), 0);
            const monthPercentage = monthCostBasis !== 0 ? (monthNetProfit / monthCostBasis) * 100 : 0;

            const chartHTML = `<div class="w-full h-40 mb-3"><canvas id="profitChart"></canvas></div>`;
            let daysHTML = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonthIndex, day);
                const dayOfWeek = date.getDay();
                const dayName = dayNames[dayOfWeek];
                const isSunday = dayOfWeek === 0;
                const sundayClass = isSunday ? 'bg-red-900/40' : '';

                const dateString = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const closedOnThisDay = trades.filter(t => t.saleDate === dateString);
                const openedOnThisDay = trades.filter(t => t.purchaseDate === dateString && t.status === 'open');

                daysHTML += `
                    <div class="day-cell flex-shrink-0 w-44 sm:w-48 ${sundayClass}">
                        <div class="flex justify-between items-center mb-1">
                            <div class="font-bold text-base text-gray-100">${day}</div>
                            <div class="text-xs text-gray-400">${dayName}</div>
                        </div>
                        <div class="flex-grow space-y-1 overflow-y-auto">
                            ${closedOnThisDay.map(trade => {
                                const p = calculateTradeProfits(trade);
                                return `<div class="trade-item bg-gray-700 flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm">${trade.cryptoSymbol.toUpperCase()}</div>
                                        <div class="text-xs mt-1">
                                            ${p.netProfit >= 0 ? '📈' : '📉'} <span class="${p.netProfit >= 0 ? 'profit' : 'loss'}">${p.netProfit.toFixed(2)} $</span>
                                            <span class="text-gray-400">(${p.percentageProfit.toFixed(1)}%)</span>
                                        </div>
                                    </div>
                                    <div class="trade-actions flex flex-col gap-1">
                                        <button class="action-btn bg-yellow-600 w-full" data-action="open-modal" data-mode="edit_closed" data-trade-id="${trade.id}">Edit</button>
                                        <button class="action-btn bg-red-600 w-full" data-action="delete-trade" data-trade-id="${trade.id}">Del</button>
                                    </div>
                                </div>`}).join('')}
                            ${openedOnThisDay.map(trade => `
                                <div class="trade-item bg-blue-900/50 flex justify-between items-center">
                                     <div>
                                        <div class="font-bold text-sm">${trade.cryptoSymbol.toUpperCase()}</div>
                                        <div class="text-xs mt-1 text-gray-300">
                                            <span>${trade.quantity} @ ${trade.purchasePrice}$</span>
                                        </div>
                                    </div>
                                    <div class="trade-actions flex flex-col gap-1">
                                        <button class="action-btn bg-yellow-600 w-full" data-action="open-modal" data-mode="edit_open" data-trade-id="${trade.id}">Edit</button>
                                        <button class="action-btn bg-red-600 w-full" data-action="delete-trade" data-trade-id="${trade.id}">Del</button>
                                    </div>
                                </div>`).join('')}
                        </div>
                        <div class="mt-auto pt-1 flex space-x-1">
                            <button class="day-action-btn bg-green-600" data-action="open-modal" data-mode="open" data-date="${dateString}">Apri</button>
                            <button class="day-action-btn bg-red-600" data-action="open-modal" data-mode="close" data-date="${dateString}" ${state.trades.filter(t=>t.status==='open').length === 0 ? 'disabled' : ''}>Chiudi</button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-800 p-3 rounded-lg shadow-md w-full text-gray-100">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-50">${monthNames[currentMonthIndex]} ${currentYear}</h3>
                        <button class="modal-btn bg-blue-600 hover:bg-blue-500 text-xs sm:text-sm" data-action="generate-monthly-report" ${tradesInMonth.length === 0 ? 'disabled' : ''}>Report Mensile 📊</button>
                    </div>
                    <div class="text-center mb-3 text-sm">
                        Guadagno/Perdita Mese: <span class="${monthNetProfit >= 0 ? 'profit' : 'loss'}">${monthNetProfit.toFixed(2)} $ (${monthPercentage.toFixed(2)} %)</span>
                    </div>
                    ${chartHTML}
                    <div class="flex items-start overflow-x-auto pb-2 space-x-2">${daysHTML}</div>
                </div>
            `;
        }

        function renderChart() {
            const chartCanvas = document.getElementById('profitChart');
            if (!chartCanvas) return;
            const { currentYear, currentMonthIndex, trades } = state;
            const daysInMonth = getDaysInMonth(currentYear, currentMonthIndex);
            const closedTrades = trades.filter(t => t.status === 'closed');
            const dailySummaries = new Map();
            closedTrades.forEach(trade => {
                const saleDate = trade.saleDate;
                if (!saleDate || !saleDate.startsWith(`${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`)) return;
                if (!dailySummaries.has(saleDate)) { dailySummaries.set(saleDate, { netProfit: 0 }); }
                dailySummaries.get(saleDate).netProfit += (calculateTradeProfits(trade).netProfit || 0);
            });
            const chartData = Array.from({ length: daysInMonth }, (_, day) => {
                const dateString = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day + 1).padStart(2, '0')}`;
                return dailySummaries.get(dateString)?.netProfit || 0;
            });
            const chartLabels = Array.from({ length: daysInMonth }, (_, day) => day + 1);
            if (profitChart) { profitChart.destroy(); }
            const ctx = chartCanvas.getContext('2d');
            profitChart = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: [{ label: 'Guadagno Netto', data: chartData, borderColor: '#00F0FF', backgroundColor: 'rgba(0, 240, 255, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#ccc', font: { size: 10 } }, grid: { color: '#555' } }, x: { ticks: { color: '#ccc', font: { size: 10 } }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#333', titleColor: '#fff', bodyColor: '#fff', callbacks: { label: (c) => `Guadagno: ${c.raw.toFixed(2)} $` } } } }
            });
        }
        
        function renderAllModals() {
            let html = '';
            if (state.modal.isOpen) html += renderTradeModal();
            if (state.confirmationModal.isOpen) html += renderConfirmationModal();
            if (state.infoModal.isOpen) html += renderInfoModal();
            return html;
        }

        function renderTradeModal() {
            const { mode, data } = state.modal;
            let content = '';
            if (mode === 'open') {
                content = `<h2 class="text-xl font-bold mb-4 text-gray-50">Apri Nuova Posizione</h2><p class="text-sm text-gray-400 mb-3">Data: ${formatDate(data.date)}</p><div class="space-y-3"><input id="open-crypto-symbol" type="text" placeholder="Simbolo Crypto (es. BTC)" required class="modal-input" /><input id="open-price" type="number" step="any" placeholder="Prezzo Acquisto ($)" required class="modal-input" /><input id="open-quantity" type="number" step="any" placeholder="Quantità" required class="modal-input" /></div><div class="flex justify-end mt-4"><button type="submit" class="modal-btn bg-indigo-600 hover:bg-indigo-700">Salva</button></div>`;
            } else if (mode === 'close') {
                const openPositions = state.trades.filter(t => t.status === 'open');
                content = `<h2 class="text-xl font-bold mb-4 text-gray-50">Chiudi Posizione</h2><p class="text-sm text-gray-400 mb-3">Data Chiusura: ${formatDate(data.date)}</p><div class="space-y-3"><select id="close-trade-select" required class="modal-input"><option value="">Seleziona posizione</option>${openPositions.map(t => `<option value="${t.id}">${t.cryptoSymbol.toUpperCase()} del ${formatDate(t.purchaseDate)}</option>`).join('')}</select><input id="close-price" type="number" step="any" placeholder="Prezzo Vendita ($)" required class="modal-input" /></div><div class="flex justify-end mt-4"><button type="submit" class="modal-btn bg-indigo-600 hover:bg-indigo-700">Chiudi Posizione</button></div>`;
            } else if (mode === 'edit_open' || mode === 'edit_closed') {
                const trade = state.trades.find(t => t.id === data.tradeId);
                content = `<h2 class="text-xl font-bold mb-4 text-gray-50">Modifica Transazione</h2><div class="space-y-3 text-sm"><label>Simbolo Crypto <input id="edit-crypto-symbol" type="text" value="${trade.cryptoSymbol}" required class="modal-input mt-1" /></label><label>Data Acquisto <input id="edit-purchase-date" type="date" value="${trade.purchaseDate}" class="modal-input mt-1" /></label>${mode === 'edit_closed' ? `<label>Data Vendita <input id="edit-sale-date" type="date" value="${trade.saleDate}" class="modal-input mt-1" /></label>` : ''}<label>Prezzo Acquisto <input id="edit-purchase-price" type="number" step="any" value="${trade.purchasePrice}" class="modal-input mt-1" /></label>${mode === 'edit_closed' ? `<label>Prezzo Vendita <input id="edit-sale-price" type="number" step="any" value="${trade.salePrice}" class="modal-input mt-1" /></label>` : ''}<label>Quantità <input id="edit-quantity" type="number" step="any" value="${trade.quantity}" class="modal-input mt-1" /></label></div><div class="flex justify-end items-center mt-6"><button type="submit" class="modal-btn bg-indigo-600 hover:bg-indigo-700">Salva Modifiche</button></div>`;
            }
            return `<div class="modal-overlay"><div class="modal-content"><button class="absolute top-2 right-3 text-2xl font-bold text-gray-400 hover:text-white" data-action="close-modal">&times;</button><form id="trade-form">${content}</form></div></div>`;
        }

        function renderConfirmationModal() {
            return `<div class="modal-overlay"><div class="modal-content"><h2 class="text-xl font-bold mb-4 text-gray-50">Conferma</h2><p class="text-gray-300 mb-6">${state.confirmationModal.message}</p><div class="flex justify-end gap-4"><button class="modal-btn bg-gray-600 hover:bg-gray-700" data-action="cancel-delete">Annulla</button><button class="modal-btn bg-red-600 hover:bg-red-700" data-action="confirm-delete">Conferma</button></div></div></div>`;
        }

        function renderInfoModal() {
            const { title, content, isLoading } = state.infoModal;
            let modalBody;

            if (isLoading) {
                modalBody = `<div class="flex justify-center items-center h-48"><div class="loader"></div></div>`;
            } else {
                modalBody = `<div class="whitespace-pre-wrap">${content || ""}</div>`;
            }

            return `<div class="modal-overlay">
                        <div class="modal-content">
                            <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-600">
                                <h2 class="text-xl font-bold text-gray-50">${title}</h2>
                                <button class="text-2xl font-bold text-gray-400 hover:text-white" data-action="close-info-modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                ${modalBody}
                            </div>
                        </div>
                    </div>`;
        }
        
        // --- EVENT HANDLERS ---
        document.getElementById('search-form').addEventListener('submit', (e) => { e.preventDefault(); const q = document.getElementById('search-input').value; if (q.trim()) window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank'); });
        document.getElementById('prev-year-btn').addEventListener('click', () => { state.currentYear--; render(); });
        document.getElementById('next-year-btn').addEventListener('click', () => { state.currentYear++; render(); });
        document.getElementById('prev-month-btn').addEventListener('click', () => { if (state.currentMonthIndex === 0) { state.currentYear--; state.currentMonthIndex = 11; } else { state.currentMonthIndex--; } render(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { if (state.currentMonthIndex === 11) { state.currentYear++; state.currentMonthIndex = 0; } else { state.currentMonthIndex++; } render(); });
        
        document.body.addEventListener('click', async (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                state.modal.isOpen = false;
                state.confirmationModal.isOpen = false;
                if (!state.infoModal.isLoading) {
                    state.infoModal.isOpen = false;
                }
                render();
                return;
            }
            
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.dataset.action;
            const { mode, date, tradeId } = target.dataset;

            switch(action) {
                case 'open-modal':
                    state.modal = { isOpen: true, mode, data: { date, tradeId } };
                    break;
                case 'delete-trade':
                    state.confirmationModal = { isOpen: true, message: 'Sei sicuro di voler eliminare questa transazione?', onConfirm: () => executeDelete(tradeId) };
                    break;
                case 'close-modal':
                    state.modal.isOpen = false;
                    break;
                case 'cancel-delete':
                    state.confirmationModal.isOpen = false;
                    break;
                 case 'close-info-modal':
                    if (!state.infoModal.isLoading) {
                        state.infoModal.isOpen = false;
                    }
                    break;
                case 'confirm-delete':
                    if (state.confirmationModal.onConfirm) state.confirmationModal.onConfirm();
                    break;
                case 'generate-monthly-report':
                    handleGenerateMonthlyReport();
                    break;
            }
            render();
        });
        
        document.body.addEventListener('submit', (e) => {
            if (e.target.id !== 'trade-form') return;
            e.preventDefault();
            const { mode, data } = state.modal;

            if (mode === 'open') {
                const newTrade = { id: uuid(), purchaseDate: data.date, purchasePrice: parseFloat(document.getElementById('open-price').value), quantity: parseFloat(document.getElementById('open-quantity').value), status: 'open', cryptoSymbol: document.getElementById('open-crypto-symbol').value.trim() };
                state.trades.push(newTrade);
            } else if (mode === 'close') {
                const tradeId = document.getElementById('close-trade-select').value;
                const tradeIndex = state.trades.findIndex(t => t.id === tradeId);
                if (tradeIndex > -1) {
                    state.trades[tradeIndex].saleDate = data.date;
                    state.trades[tradeIndex].salePrice = parseFloat(document.getElementById('close-price').value);
                    state.trades[tradeIndex].status = 'closed';
                }
            } else if (mode === 'edit_open' || mode === 'edit_closed') {
                const tradeId = data.tradeId;
                const tradeIndex = state.trades.findIndex(t => t.id === tradeId);
                if (tradeIndex > -1) {
                    state.trades[tradeIndex].purchaseDate = document.getElementById('edit-purchase-date').value;
                    state.trades[tradeIndex].purchasePrice = parseFloat(document.getElementById('edit-purchase-price').value);
                    state.trades[tradeIndex].quantity = parseFloat(document.getElementById('edit-quantity').value);
                    state.trades[tradeIndex].cryptoSymbol = document.getElementById('edit-crypto-symbol').value.trim();
                    if (mode === 'edit_closed') {
                        state.trades[tradeIndex].saleDate = document.getElementById('edit-sale-date').value;
                        state.trades[tradeIndex].salePrice = parseFloat(document.getElementById('edit-sale-price').value);
                    }
                }
            }
            saveTrades();
            state.modal = { isOpen: false };
            render();
        });

        function executeDelete(tradeId) {
            state.trades = state.trades.filter(t => t.id !== tradeId);
            saveTrades();
            state.confirmationModal = { isOpen: false };
            render();
        }

        function handleGenerateMonthlyReport() {
            const { currentYear, currentMonthIndex, trades } = state;
            const monthKey = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
            const tradesInMonth = trades
                .filter(t => t.status === 'closed' && t.saleDate && t.saleDate.startsWith(monthKey))
                .map(calculateTradeProfits);

            if (tradesInMonth.length === 0) {
                state.infoModal = { isOpen: true, title: `Report di ${monthNames[currentMonthIndex]} ${currentYear}`, content: 'Nessuna operazione chiusa in questo mese.', isLoading: false };
                render();
                return;
            }

            const totalProfit = tradesInMonth.reduce((sum, t) => sum + t.netProfit, 0);
            const winningTrades = tradesInMonth.filter(t => t.netProfit > 0);
            const losingTrades = tradesInMonth.filter(t => t.netProfit <= 0);
            
            let bestTrade = null;
            if (winningTrades.length > 0) {
                bestTrade = winningTrades.reduce((best, current) => current.netProfit > best.netProfit ? current : best);
            }
            
            let worstTrade = null;
            if (losingTrades.length > 0) {
                worstTrade = losingTrades.reduce((worst, current) => current.netProfit < worst.netProfit ? current : worst);
            }

            let reportText = `Riepilogo Performance
- Profitto/Perdita Totale: ${totalProfit.toFixed(2)} $
- Operazioni in Profitto: ${winningTrades.length}
- Operazioni in Perdita: ${losingTrades.length}
`;
            if (bestTrade) {
                reportText += `

Miglior Trade
- Crypto: ${bestTrade.cryptoSymbol.toUpperCase()}
- Profitto: ${bestTrade.netProfit.toFixed(2)} $`;
            }
            if (worstTrade) {
                 reportText += `

Peggior Trade
- Crypto: ${worstTrade.cryptoSymbol.toUpperCase()}
- Perdita: ${worstTrade.netProfit.toFixed(2)} $`;
            }

            state.infoModal = { isOpen: true, title: `Report di ${monthNames[currentMonthIndex]} ${currentYear}`, content: reportText, isLoading: false };
            render();
        }
        
        // --- ONLINE/OFFLINE STATUS ---
        function updateOnlineStatus() {
             // Funzione vuota, mantenuta per compatibilità se si volessero riaggiungere funzioni online
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);


        // --- API & INITIALIZATION ---
        async function fetchTickerData() {
            if (!navigator.onLine) {
                return;
            }
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false');
                if (!response.ok) throw new Error('Ticker API response not OK');
                state.tickerData = await response.json();
            } catch (error) {
                console.error("Could not fetch ticker data:", error);
            } finally {
                render();
            }
        }
        
        // Initial Load
        loadTrades();
        fetchTickerData();
        setInterval(fetchTickerData, 60000);
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
    });
    </script>
</body>
</html>
